name: Bootstrap Digital Ocean Droplet

on:
  workflow_dispatch:
    inputs:
      region:
        description: "Digital Ocean region (e.g., nyc3, sfo3, sgp1)"
        required: true
        default: "sfo3"
      size:
        description: "Droplet size slug (e.g., s-1vcpu-1gb, s-2vcpu-2gb)"
        required: true
        default: "s-1vcpu-1gb"
      image:
        description: "OS image slug (e.g., ubuntu-22-04-x64)"
        required: true
        default: "ubuntu-22-04-x64"

env:
  DROPLET_NAME: rwp-live
  DOCKERHUB_USERNAME: rileywheadon
  EMAIL: rileywheadon@gmail.com

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      # Setup
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DIGITALOCEAN_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      # Pre-flight checks 
      - name: Check if droplet already exists
        run: |
          if doctl compute droplet list --format Name --no-header | grep -qw "$DROPLET_NAME"; then
            echo "[ERROR] Droplet '$DROPLET_NAME' already exists. Aborting."
            exit 1
          fi
          echo "No existing droplet found. Proceeding."

      # Cloud-init
      - name: Prepare cloud-init
        run: |
          sed \
            -e "s|\${DOCKERHUB_USERNAME}|${{ env.DOCKERHUB_USERNAME }}|g" \
            -e "s|\${DOCKERHUB_TOKEN}|${{ secrets.DOCKERHUB_TOKEN }}|g" \
            -e "s|\${EMAIL}|${{ env.EMAIL }}|g" \
            deploy/cloud-init.yaml > /tmp/cloud-init.yaml

      # Create droplet
      - name: Create droplet
        run: |
          DROPLET_ID=$(doctl compute droplet create "$DROPLET_NAME" \
            --region "${{ inputs.region }}" \
            --size "${{ inputs.size }}" \
            --image "${{ inputs.image }}" \
            --ssh-keys "${{ secrets.DIGITALOCEAN_SSH_KEY_ID }}" \
            --user-data-file /tmp/cloud-init.yaml \
            --wait \
            --format ID --no-header | tr -d '[:space:]')
          echo "DROPLET_ID=$DROPLET_ID" >> "$GITHUB_ENV"
          echo "[INFO] Created droplet with ID: $DROPLET_ID"

      - name: Get droplet IP
        run: |
          DROPLET_IP=$(doctl compute droplet get "$DROPLET_ID" --format PublicIPv4 --no-header | tr -d '[:space:]')
          echo "DROPLET_IP=$DROPLET_IP" >> "$GITHUB_ENV"
          echo "[INFO] Droplet IP: $DROPLET_IP"

      # Wait for SSH and cloud-init
      - name: Wait for SSH to be available
        run: |
          echo "Waiting for SSH on $DROPLET_IP..."
          for i in $(seq 1 30); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes root@"$DROPLET_IP" 'echo ok' 2>/dev/null; then
              echo "[INFO] SSH is available."
              exit 0
            fi
            echo "[WARNING] Attempt $i/30 - retrying in 10s..."
            sleep 10
          done
          echo "[ERROR] SSH did not become available in time."
          exit 1

      - name: Wait for cloud-init to complete
        run: |
          echo "[INFO] Waiting for cloud-init to finish on $DROPLET_IP..."
          ssh -o StrictHostKeyChecking=no root@"$DROPLET_IP" 'cloud-init status --wait'
          echo "[INFO] Cloud-init complete."

      - name: Print summary
        run: |
          echo "## Bootstrap Complete ðŸš€" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Resource | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Droplet Name | \`$DROPLET_NAME\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Droplet IP | \`$DROPLET_IP\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Region | \`${{ inputs.region }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | \`${{ inputs.size }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | \`${{ inputs.image }}\` |" >> "$GITHUB_STEP_SUMMARY"
